trigger:
  - master

variables:
  imageName: 'htmlapp'
  tag: '$(Build.BuildId)'
  acrLogin: 'project2acr.azurecr.io'

stages:

# ------------------------------- #
# 1. Build Stage
# ------------------------------- #
- stage: Build
  displayName: "Build & Push Docker Image"
  jobs:
    - job: Build
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        # Checkout code
        - checkout: self

        # Install Podman
        - task: Bash@3
          displayName: "Install Podman"
          inputs:
            targetType: inline
            script: |
              sudo apt-get update
              sudo apt-get install -y podman

        # Build & Push Docker image to ACR
        - task: Bash@3
          displayName: "Build & Push Image"
          inputs:
            targetType: inline
            script: |
              echo "Logging in to ACR..."
              podman login $(acrLogin) --username $(ACR_USERNAME) --password $(ACR_PASSWORD)
              echo "Building image..."
              podman build -t $(acrLogin)/$(imageName):$(tag) .
              echo "Pushing image..."
              podman push $(acrLogin)/$(imageName):$(tag)

        # Save image tag to file
        - task: Bash@3
          displayName: "Save Image Tag to File"
          inputs:
            targetType: inline
            script: |
              echo $(tag) > imageTag.txt

        # Publish the tag file as artifact
        - publish: imageTag.txt
          artifact: imageTag

# ------------------------------- #
# 2. Deploy to DEV
# ------------------------------- #
- stage: Deploy_Dev
  displayName: "Deploy to DEV"
  dependsOn: Build
  jobs:
    - deployment: DeployDev
      environment: dev  # Manual approval optional here
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: imageTag

              - task: AzureCLI@2
                displayName: "Deploy to ACI (Dev)"
                inputs:
                  azureSubscription: "azure-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    # Read tag from artifact
                    TAG=$(cat $(Pipeline.Workspace)/imageTag/imageTag.txt)
                    echo "Deploying image: $(acrLogin)/$(imageName):$TAG"

                    # Delete existing container if any
                    az container delete --resource-group project2-rg --name html-container --yes || true

                    # Deploy new container
                    az container create \
                      --resource-group project2-rg \
                      --name html-container \
                      --image $(acrLogin)/$(imageName):$TAG \
                      --os-type Linux \
                      --ports 80 \
                      --dns-name-label html-demo-dev-$TAG \
                      --registry-login-server $(acrLogin) \
                      --registry-username $(ACR_USERNAME) \
                      --registry-password $(ACR_PASSWORD) \
                      --cpu 1 \
                      --memory 1

# ------------------------------- #
# 3. Deploy to PROD
# ------------------------------- #
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_Dev
  jobs:
    - deployment: DeployProd
      environment: prod  # Manual approval configured in Azure DevOps Environment
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: imageTag

              - task: AzureCLI@2
                displayName: "Deploy to ACI (Prod)"
                inputs:
                  azureSubscription: "azure-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    # Read tag from artifact
                    TAG=$(cat $(Pipeline.Workspace)/imageTag/imageTag.txt)
                    echo "Deploying image: $(acrLogin)/$(imageName):$TAG"

                    # Delete existing PROD container if any
                    az container delete --resource-group project2-rg --name html-container-prod --yes || true

                    # Deploy new PROD container
                    az container create \
                      --resource-group project2-rg \
                      --name html-container-prod \
                      --image $(acrLogin)/$(imageName):$TAG \
                      --os-type Linux \
                      --ports 80 \
                      --dns-name-label html-demo-prod-$TAG \
                      --registry-login-server $(acrLogin) \
                      --registry-username $(ACR_USERNAME) \
                      --registry-password $(ACR_PASSWORD) \
                      --cpu 1 \
                      --memory 1
