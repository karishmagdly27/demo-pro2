trigger:
  - master

variables:
  imageName: 'htmlapp'
  tag: '$(Build.BuildId)'
  acrLogin: 'project2acr.azurecr.io'

stages:

# ------------------------------- #
# 1. Build Stage
# ------------------------------- #
- stage: Build
  displayName: "Build & Push Docker Image"
  jobs:
    - job: Build
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - task: Bash@3
          displayName: "Install Podman"
          inputs:
            targetType: inline
            script: |
              sudo apt-get update
              sudo apt-get install -y podman

        - task: Bash@3
          displayName: "Build & Push Image"
          inputs:
            targetType: inline
            script: |
              podman login $(acrLogin) --username $(ACR_USERNAME) --password $(ACR_PASSWORD)
              podman build -t $(acrLogin)/$(imageName):$(tag) .
              podman push $(acrLogin)/$(imageName):$(tag)

        - publish: $(tag)
          artifact: imageTag

# ------------------------------- #
# 2. Deploy to DEV
# ------------------------------- #
- stage: Deploy_Dev
  displayName: "Deploy to DEV"
  dependsOn: Build
  jobs:
    - deployment: DeployDev
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: imageTag

              - task: AzureCLI@2
                displayName: "Deploy to ACI (Dev)"
                inputs:
                  azureSubscription: "azure-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    TAG=$(cat $(Pipeline.Workspace)/imageTag/imageTag)
                    az container delete --resource-group project2-rg --name html-container --yes || true
                    az container create \
                      --resource-group project2-rg \
                      --name html-container \
                      --image $(acrLogin)/$(imageName):$TAG \
                      --os-type Linux \
                      --ports 80 \
                      --dns-name-label html-demo-dev-$TAG \
                      --registry-login-server $(acrLogin) \
                      --registry-username $(ACR_USERNAME) \
                      --registry-password $(ACR_PASSWORD) \
                      --cpu 1 \
                      --memory 1

# ------------------------------- #
# 3. Deploy to PROD (Manual Approval)
# ------------------------------- #
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_Dev
  approval:
    - name: "Manual Approval"
  jobs:
    - deployment: DeployProd
      environment: prod
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: imageTag

              - task: AzureCLI@2
                displayName: "Deploy to ACI (Prod)"
                inputs:
                  azureSubscription: "azure-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    TAG=$(cat $(Pipeline.Workspace)/imageTag/imageTag)
                    az container delete --resource-group project2-rg --name html-container-prod --yes || true
                    az container create \
                      --resource-group project2-rg \
                      --name html-container-prod \
                      --image $(acrLogin)/$(imageName):$TAG \
                      --os-type Linux \
                      --ports 80 \
                      --dns-name-label html-demo-prod-$TAG \
                      --registry-login-server $(acrLogin) \
                      --registry-username $(ACR_USERNAME) \
                      --registry-password $(ACR_PASSWORD) \
                      --cpu 1 \
                      --memory 1
